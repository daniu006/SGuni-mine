// schema-profiles.prisma - Base de datos de PERFILES Y REFERENCIAS
generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/@prisma/client-profiles"
}

datasource db_profiles {
  provider = "postgresql"
}

model UserReference {
  id        Int      @id
  name      String
  email     String   @unique
  roleId    Int      @map("role_id")
  status    String
  syncedAt  DateTime @default(now()) @map("synced_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  teacherProfile TeacherProfile?
  studentProfile StudentProfile?

  @@index([roleId])
  @@map("user_reference")
}

// Referencia a especialidades (sincronizada desde DB academic)
model SpecialityReference {
  id       Int      @id
  name     String
  syncedAt DateTime @default(now()) @map("synced_at")

  teachers TeacherProfile[]

  @@map("speciality_reference")
}

// Referencia a carreras (sincronizada desde DB academic)
model CareerReference {
  id          Int      @id
  name        String
  totalCicles Int      @map("total_cicles")
  syncedAt    DateTime @default(now()) @map("synced_at")

  teachers TeacherProfile[]
  students StudentProfile[]

  @@map("career_reference")
}

// Referencia a materias (sincronizada desde DB academic)
model SubjectReference {
  id             Int      @id
  name           String
  careerId       Int      @map("career_id")
  cicleNumber    Int      @map("cicle_number")
  totalSpots     Int      @default(30) @map("total_spots")
  availableSpots Int      @default(30) @map("available_spots")
  syncedAt       DateTime @default(now()) @map("synced_at")

  subjectAssignments SubjectAssignment[]
  studentSubjects    StudentSubject[]

  @@index([careerId, cicleNumber])
  @@map("subject_reference")
}

// Perfil de docente
model TeacherProfile {
  id             Int      @id @default(autoincrement())
  userId         Int      @unique @map("user_id")
  specialityId   Int      @map("speciality_id")
  careerId       Int      @map("career_id")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  employmentType String // 'FULL_TIME' | 'PART_TIME'

  user       UserReference       @relation(fields: [userId], references: [id])
  speciality SpecialityReference @relation(fields: [specialityId], references: [id])
  career     CareerReference     @relation(fields: [careerId], references: [id])
  subjects   SubjectAssignment[]

  @@map("teacher_profile")
}

// Perfil de estudiante
model StudentProfile {
  id           Int      @id @default(autoincrement())
  userId       Int      @unique @map("user_id")
  careerId     Int      @map("career_id")
  currentCicle Int      @map("current_cicle")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user            UserReference    @relation(fields: [userId], references: [id])
  career          CareerReference  @relation(fields: [careerId], references: [id])
  studentSubjects StudentSubject[]

  @@index([careerId, currentCicle])
  @@map("student_profile")
}

// Asignaci√≥n de materias a profesores
model SubjectAssignment {
  id               Int      @id @default(autoincrement())
  teacherProfileId Int      @map("teacher_profile_id")
  subjectId        Int      @map("subject_id")
  assignedAt       DateTime @default(now()) @map("assigned_at")

  teacherProfile TeacherProfile   @relation(fields: [teacherProfileId], references: [id], onDelete: Cascade)
  subject        SubjectReference @relation(fields: [subjectId], references: [id])

  @@unique([teacherProfileId, subjectId])
  @@map("subject_assignment")
}

// Materias inscritas por estudiantes
model StudentSubject {
  id               Int             @id @default(autoincrement())
  studentProfileId Int             @map("student_profile_id")
  subjectId        Int             @map("subject_id")
  grade            Decimal?        @db_profiles.Decimal(5, 2)
  status           String          @default("enrolled")
  enrolledAt       DateTime        @default(now()) @map("enrolled_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")
  cycleId          Int?
  cycle            CycleReference? @relation(fields: [cycleId], references: [id])

  studentProfile StudentProfile   @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)
  subject        SubjectReference @relation(fields: [subjectId], references: [id])

  @@unique([studentProfileId, subjectId])
  @@index([cycleId])
  @@map("student_subject")
}

model CycleReference {
  id       Int      @id
  name     String
  year     Int
  period   Int
  syncedAt DateTime @default(now()) @map("synced_at")

  studentSubjects StudentSubject[]

  @@map("cycle_reference")
}
